<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Aaron Robotham &amp; Dan Taranu" />

<meta name="date" content="2016-11-21" />

<title>ProFit: Galaxy Fitting Example</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">ProFit: Galaxy Fitting Example</h1>
<h4 class="author"><em>Aaron Robotham &amp; Dan Taranu</em></h4>
<h4 class="date"><em>2016-11-21</em></h4>



<div id="prepare-the-test-data" class="section level2">
<h2>Prepare the test data</h2>
<p>First load the libraries we need:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(knitr)
<span class="kw">library</span>(ProFit)</code></pre></div>
<pre><code>## Loading required package: FITSio</code></pre>
<pre><code>## Loading required package: LaplacesDemon</code></pre>
<pre><code>## Loading required package: magicaxis</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: plotrix</code></pre>
<pre><code>## Loading required package: sm</code></pre>
<pre><code>## Package 'sm', version 2.2-5.4: type help(sm) for summary information</code></pre>
<pre><code>## 
## Attaching package: 'sm'</code></pre>
<pre><code>## The following object is masked from 'package:MASS':
## 
##     muscle</code></pre>
<pre><code>## Loading required package: mapproj</code></pre>
<pre><code>## Loading required package: maps</code></pre>
<pre><code>## Loading required package: celestial</code></pre>
<pre><code>## Loading required package: RANN</code></pre>
<pre><code>## Loading required package: NISTunits</code></pre>
<pre><code>## Loading required package: pracma</code></pre>
<pre><code>## 
## Attaching package: 'pracma'</code></pre>
<pre><code>## The following object is masked from 'package:sm':
## 
##     nile</code></pre>
<pre><code>## The following objects are masked from 'package:LaplacesDemon':
## 
##     Mode, logit, loglog</code></pre>
<pre><code>## Loading required package: R2Cuba</code></pre>
<pre><code>## Loading required package: RColorBrewer</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(FITSio)</code></pre></div>
<p>Next we load a table of data describing GAMA galaxies:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">'ExampleInit'</span>, <span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>)
<span class="kw">kable</span>(<span class="kw">head</span>(ExampleInit, <span class="dv">10</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">CATAID</th>
<th align="right">sersic.xcen1</th>
<th align="right">sersic.ycen1</th>
<th align="right">sersic.mag1</th>
<th align="right">sersic.mag2</th>
<th align="right">sersic.re1</th>
<th align="right">sersic.re2</th>
<th align="right">sersic.nser1</th>
<th align="right">sersic.ang2</th>
<th align="right">sersic.axrat2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">265769</td>
<td align="right">122.8069</td>
<td align="right">87.3328</td>
<td align="right">17.08908</td>
<td align="right">17.08908</td>
<td align="right">8.71420</td>
<td align="right">17.4284</td>
<td align="right">3.4292</td>
<td align="right">105.8498</td>
<td align="right">0.1541</td>
</tr>
<tr class="even">
<td align="right">265911</td>
<td align="right">84.8832</td>
<td align="right">94.5951</td>
<td align="right">16.83217</td>
<td align="right">16.83217</td>
<td align="right">7.05740</td>
<td align="right">14.1148</td>
<td align="right">4.3776</td>
<td align="right">140.8191</td>
<td align="right">0.4891</td>
</tr>
<tr class="odd">
<td align="right">265940</td>
<td align="right">80.3975</td>
<td align="right">52.2173</td>
<td align="right">18.04857</td>
<td align="right">18.04857</td>
<td align="right">5.96290</td>
<td align="right">11.9258</td>
<td align="right">4.6010</td>
<td align="right">112.2746</td>
<td align="right">0.4875</td>
</tr>
<tr class="even">
<td align="right">265943</td>
<td align="right">53.7013</td>
<td align="right">83.6956</td>
<td align="right">17.70547</td>
<td align="right">17.70547</td>
<td align="right">6.42060</td>
<td align="right">12.8412</td>
<td align="right">4.5086</td>
<td align="right">168.2385</td>
<td align="right">0.4179</td>
</tr>
<tr class="odd">
<td align="right">265981</td>
<td align="right">148.8727</td>
<td align="right">106.4069</td>
<td align="right">16.85618</td>
<td align="right">16.85618</td>
<td align="right">11.00100</td>
<td align="right">22.0020</td>
<td align="right">2.9434</td>
<td align="right">59.6690</td>
<td align="right">0.2621</td>
</tr>
<tr class="even">
<td align="right">265986</td>
<td align="right">78.1780</td>
<td align="right">79.9999</td>
<td align="right">18.97747</td>
<td align="right">18.97747</td>
<td align="right">6.80575</td>
<td align="right">13.6115</td>
<td align="right">2.0082</td>
<td align="right">103.2134</td>
<td align="right">0.0423</td>
</tr>
<tr class="odd">
<td align="right">265985</td>
<td align="right">51.3467</td>
<td align="right">73.0023</td>
<td align="right">19.03898</td>
<td align="right">19.03898</td>
<td align="right">5.77065</td>
<td align="right">11.5413</td>
<td align="right">2.7402</td>
<td align="right">0.7028</td>
<td align="right">0.5400</td>
</tr>
<tr class="even">
<td align="right">266033</td>
<td align="right">66.0826</td>
<td align="right">79.0872</td>
<td align="right">17.39138</td>
<td align="right">17.39138</td>
<td align="right">6.25480</td>
<td align="right">12.5096</td>
<td align="right">4.9178</td>
<td align="right">39.5336</td>
<td align="right">0.3336</td>
</tr>
<tr class="odd">
<td align="right">266035</td>
<td align="right">105.1495</td>
<td align="right">78.5289</td>
<td align="right">18.18017</td>
<td align="right">18.18017</td>
<td align="right">11.38780</td>
<td align="right">22.7756</td>
<td align="right">2.9550</td>
<td align="right">56.3237</td>
<td align="right">0.6222</td>
</tr>
<tr class="even">
<td align="right">266105</td>
<td align="right">264.8947</td>
<td align="right">219.5667</td>
<td align="right">15.45027</td>
<td align="right">15.45027</td>
<td align="right">36.68265</td>
<td align="right">73.3653</td>
<td align="right">3.9704</td>
<td align="right">94.4409</td>
<td align="right">0.3477</td>
</tr>
</tbody>
</table>
<p>There are 2 data source options: KiDS or SDSS (the galaxies are the same)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">datasource=<span class="st">'KiDS'</span></code></pre></div>
<p>Now we can extract out the example files we have available for fitting by checking the contents of the directory containing the example FITS files:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ExampleFiles=<span class="kw">list.files</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>,datasource,<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))
ExampleIDs=<span class="kw">unlist</span>(<span class="kw">strsplit</span>(ExampleFiles[<span class="kw">grep</span>(<span class="st">'fitim'</span>,ExampleFiles)],<span class="st">'fitim.fits'</span>))
ExampleIDs</code></pre></div>
<pre><code>##  [1] &quot;G265911&quot; &quot;G265940&quot; &quot;G266033&quot; &quot;G266035&quot; &quot;G266662&quot; &quot;G267199&quot; &quot;G267489&quot;
##  [8] &quot;G267525&quot; &quot;G278109&quot; &quot;G279148&quot;</code></pre>
<p>There are 10 example galaxies included. Here we run example 1:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">useID=ExampleIDs[<span class="dv">1</span>]
image =<span class="st"> </span><span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="kw">paste</span>(datasource,<span class="st">'/'</span>,useID,<span class="st">'fitim.fits'</span>,<span class="dt">sep=</span><span class="st">''</span>),<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))$imDat
mask =<span class="st"> </span><span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="kw">paste</span>(datasource,<span class="st">'/'</span>,useID,<span class="st">'mskim.fits'</span>,<span class="dt">sep=</span><span class="st">''</span>),<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))$imDat
sigma =<span class="st"> </span><span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="kw">paste</span>(datasource,<span class="st">'/'</span>,useID,<span class="st">'sigma.fits'</span>,<span class="dt">sep=</span><span class="st">''</span>),<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))$imDat
segim =<span class="st"> </span><span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="kw">paste</span>(datasource,<span class="st">'/'</span>,useID,<span class="st">'segim.fits'</span>,<span class="dt">sep=</span><span class="st">''</span>),<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))$imDat
psf =<span class="st"> </span><span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="kw">paste</span>(datasource,<span class="st">'/'</span>,useID,<span class="st">'psfim.fits'</span>,<span class="dt">sep=</span><span class="st">''</span>),<span class="dt">package=</span><span class="st">&quot;ProFit&quot;</span>))$imDat</code></pre></div>
<p>Next we extract parameters for a very rough model (not meant to look too good yet):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">useIDnum=<span class="kw">as.integer</span>(<span class="kw">strsplit</span>(useID,<span class="st">'G'</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>])
useloc=<span class="kw">which</span>(ExampleInit$CATAID==useIDnum)</code></pre></div>
</div>
<div id="setup-the-fitting-data-structures" class="section level2">
<h2>Setup the fitting data structures</h2>
<p>For our initial model we treat component 1 as the putative bulge and component 2 as the putative disk. We are going to attempt a fit where the disk is forced to have nser=1 and the bulge has an axial ratio of 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modellist=<span class="kw">list</span>(
  <span class="dt">sersic=</span><span class="kw">list</span>(
    <span class="dt">xcen=</span> <span class="kw">c</span>(<span class="kw">dim</span>(image)[<span class="dv">1</span>]/<span class="dv">2</span>, <span class="kw">dim</span>(image)[<span class="dv">1</span>]/<span class="dv">2</span>),
    <span class="dt">ycen=</span> <span class="kw">c</span>(<span class="kw">dim</span>(image)[<span class="dv">2</span>]/<span class="dv">2</span>, <span class="kw">dim</span>(image)[<span class="dv">2</span>]/<span class="dv">2</span>),
    <span class="dt">mag=</span> <span class="kw">c</span>(ExampleInit$sersic.mag1[useloc], ExampleInit$sersic.mag2[useloc]),
    <span class="dt">re=</span> <span class="kw">c</span>(ExampleInit$sersic.re1[useloc], ExampleInit$sersic.re2[useloc])*
<span class="st">      </span>if(datasource==<span class="st">'KiDS'</span>){<span class="dv">1</span>}else{<span class="fl">0.2</span>/<span class="fl">0.339</span>},
    <span class="dt">nser=</span> <span class="kw">c</span>(ExampleInit$sersic.nser1[useloc], <span class="dv">1</span>),  <span class="co">#Disk is initially nser=1</span>
    <span class="dt">ang=</span> <span class="kw">c</span>(ExampleInit$sersic.ang2[useloc], ExampleInit$sersic.ang2[useloc]),
    <span class="dt">axrat=</span> <span class="kw">c</span>(<span class="dv">1</span>, ExampleInit$sersic.axrat2[useloc]),  <span class="co">#Bulge is initially axrat=1</span>
    <span class="dt">box=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)
  )
)
modellist</code></pre></div>
<pre><code>## $sersic
## $sersic$xcen
## [1] 84.5 84.5
## 
## $sersic$ycen
## [1] 93.5 93.5
## 
## $sersic$mag
## [1] 16.83217 16.83217
## 
## $sersic$re
## [1]  7.0574 14.1148
## 
## $sersic$nser
## [1] 4.3776 1.0000
## 
## $sersic$ang
## [1] 140.8191 140.8191
## 
## $sersic$axrat
## [1] 1.0000 0.4891
## 
## $sersic$box
## [1] 0 0</code></pre>
<p>The pure model (no PSF):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(<span class="kw">profitMakeModel</span>(modellist,<span class="dt">dim=</span><span class="kw">dim</span>(image)))</code></pre></div>
<p>The original image:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(image)</code></pre></div>
<p>The convolved model (with PSF):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(<span class="kw">profitMakeModel</span>(modellist,<span class="dt">dim=</span><span class="kw">dim</span>(image),<span class="dt">psf=</span>psf))</code></pre></div>
<p>Next we define our list of what we want to fit (where TRUE means we will fit it later):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tofit=<span class="kw">list</span>(
  <span class="dt">sersic=</span><span class="kw">list</span>(
    <span class="dt">xcen=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">NA</span>), <span class="co">#We fit for xcen and tie the two togther</span>
    <span class="dt">ycen=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">NA</span>), <span class="co">#We fit for ycen and tie the two togther</span>
    <span class="dt">mag=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">TRUE</span>), <span class="co">#Fit for both</span>
    <span class="dt">re=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">TRUE</span>), <span class="co">#Fit for both</span>
    <span class="dt">nser=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">FALSE</span>), <span class="co">#Fit for bulge</span>
    <span class="dt">ang=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">TRUE</span>), <span class="co">#Fit for disk</span>
    <span class="dt">axrat=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">TRUE</span>), <span class="co">#Fit for disk</span>
    <span class="dt">box=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>) <span class="co">#Fit for neither</span>
  )
)</code></pre></div>
<p>Now we define what parameters should be fitted in log space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tolog=<span class="kw">list</span>(
  <span class="dt">sersic=</span><span class="kw">list</span>(
    <span class="dt">xcen=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>),
    <span class="dt">ycen=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>),
    <span class="dt">mag=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>),
    <span class="dt">re=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">TRUE</span>), <span class="co">#re is best fit in log space</span>
    <span class="dt">nser=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">TRUE</span>), <span class="co">#nser is best fit in log space</span>
    <span class="dt">ang=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>),
    <span class="dt">axrat=</span> <span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">TRUE</span>), <span class="co">#axrat is best fit in log space</span>
    <span class="dt">box=</span> <span class="kw">c</span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>)
  )
)</code></pre></div>
<p>Now we specify the priors object The priors object is really a function that takes modellist as an input and returns an addative log-likelihood sum that increments the total log-likelihood for the current realisation of the model.</p>
<p>The elements you access within the modellist structure must really exist or ProFit will stop with an error. The modellist used internally will be the linear (un-logged version), so logging must be made within the function if, e.g., log-normal distributions are required. You do not have to apply priors to each parameter- notice below a few are left out.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">priors=function(new,init,<span class="dt">sigmas=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">30</span>,<span class="dv">30</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>)){
  LL=<span class="kw">sum</span>(
      <span class="kw">dnorm</span>(new$sersic$xcen,init$sersic$xcen,sigmas[<span class="dv">1</span>:<span class="dv">2</span>],<span class="dt">log=</span><span class="ot">TRUE</span>),
      <span class="kw">dnorm</span>(new$sersic$ycen,init$sersic$ycen,sigmas[<span class="dv">3</span>:<span class="dv">4</span>],<span class="dt">log=</span><span class="ot">TRUE</span>),
      <span class="kw">dnorm</span>(new$sersic$mag,init$sersic$mag,sigmas[<span class="dv">5</span>:<span class="dv">6</span>],<span class="dt">log=</span><span class="ot">TRUE</span>),
      <span class="kw">dnorm</span>(<span class="kw">log10</span>(new$sersic$re),<span class="kw">log10</span>(init$sersic$re),sigmas[<span class="dv">7</span>:<span class="dv">8</span>],<span class="dt">log=</span><span class="ot">TRUE</span>),
      <span class="kw">dnorm</span>(<span class="kw">log10</span>(new$sersic$nser),<span class="kw">log10</span>(init$sersic$nser),sigmas[<span class="dv">9</span>:<span class="dv">10</span>],<span class="dt">log=</span><span class="ot">TRUE</span>),
      <span class="kw">dnorm</span>(<span class="kw">log10</span>(new$sersic$axrat),<span class="kw">log10</span>(init$sersic$axrat),sigmas[<span class="dv">13</span>:<span class="dv">14</span>],<span class="dt">log=</span><span class="ot">TRUE</span>)
  )
  return=LL
}</code></pre></div>
<p>The hard intervals should also be specified in linear space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">intervals=<span class="kw">list</span>(
  <span class="dt">sersic=</span><span class="kw">list</span>(
    <span class="dt">xcen=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">300</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">300</span>)),
    <span class="dt">ycen=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">300</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">300</span>)),
    <span class="dt">mag=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">30</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">30</span>)),
    <span class="dt">re=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">100</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">100</span>)),
    <span class="dt">nser=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="fl">0.5</span>,<span class="dv">20</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="fl">0.5</span>,<span class="dv">20</span>)),
    <span class="dt">ang=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(-<span class="dv">180</span>,<span class="dv">360</span>),<span class="dt">lim=</span><span class="kw">c</span>(-<span class="dv">180</span>,<span class="dv">360</span>)),
    <span class="dt">axrat=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>),<span class="dt">lim=</span><span class="kw">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>)),
    <span class="dt">box=</span><span class="kw">list</span>(<span class="dt">lim=</span><span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">1</span>),<span class="dt">lim=</span><span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">1</span>))
  )
)</code></pre></div>
<p>It is not a requirement to have a constraints object that do more complex manipulations of the modellist, but it is useful to stop undesirable (perhaps unphysical) exploration.</p>
<p>The constraint object is really a function that takes modellist as an input and returns a modifed (but identical in skeleton structure) modellist output. For this reason it is generally best to make manipulations on the modellist directly rather than attempting to unlist (collapse) it and rebuild it etc (this can be done, but it is prone to coding error).</p>
<p>The elements you access within the modellist structure must really exist or ProFit will stop with an error. All constraints manipulations happen internally to the model in linear (un-logged) form.</p>
<p>Setup the data structure we need for optimisation, taking a few seconds to find the optimal convolution method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Data=<span class="kw">profitSetupData</span>(<span class="dt">image=</span>image, <span class="dt">sigma=</span>sigma, <span class="dt">segim=</span>segim, <span class="dt">mask=</span>mask, <span class="dt">psf=</span>psf,
                     <span class="dt">modellist=</span>modellist, <span class="dt">tofit=</span>tofit, <span class="dt">tolog=</span>tolog, <span class="dt">priors=</span>priors,
                     <span class="dt">intervals=</span>intervals,<span class="dt">magzero=</span><span class="dv">0</span>, <span class="dt">algo.func=</span><span class="st">'optim'</span>, <span class="dt">like.func =</span> <span class="st">&quot;t&quot;</span>,
                     <span class="dt">verbose=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>This produces a fairly complex R object, but with all the bits we need for fitting, e.g. (notice the tolog parameteres are now logged):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Data$init</code></pre></div>
<pre><code>##  sersic.xcen1  sersic.ycen1   sersic.mag1   sersic.mag2    sersic.re1 
##    84.5000000    93.5000000    16.8321750    16.8321750     0.8486447 
##    sersic.re2  sersic.nser1   sersic.ang2 sersic.axrat2 
##     1.1496747     0.6412361   140.8191000    -0.3106023</code></pre>
<p>These are the parameters we wish to fit for, and we take the initial guesses from the model list we provided before.</p>
<p>We can test how things currently look (we get an output because we set verbose=TRUE earlier):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(<span class="dt">parm=</span>Data$init, <span class="dt">Data=</span>Data, <span class="dt">makeplots=</span><span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="do-some-fitting" class="section level2">
<h2>Do some fitting</h2>
<p>First we will try <code>optim</code> BFGS.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sigmas=<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">30</span>,<span class="dv">30</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>)
optimfit=<span class="kw">optim</span>(Data$init, profitLikeModel, <span class="dt">method=</span><span class="st">'BFGS'</span>, <span class="dt">Data=</span>Data,
<span class="dt">control=</span><span class="kw">list</span>(<span class="dt">fnscale=</span>-<span class="dv">1</span>,<span class="dt">parscale=</span>sigmas[<span class="kw">which</span>(<span class="kw">unlist</span>(tofit))]))</code></pre></div>
<p>The best <code>optim</code> BFGS fit is given by:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">optimfit$par</code></pre></div>
<p>Check it out:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(optimfit$par,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">1</span>))
<span class="kw">profitLikeModel</span>(optimfit$par,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">2</span>))
<span class="kw">profitLikeModel</span>(optimfit$par,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="st">'all'</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">modeloptim=<span class="kw">profitRemakeModellist</span>(<span class="dt">parm=</span>optimfit$par, <span class="dt">Data=</span>Data)$modellist
<span class="kw">profitEllipsePlot</span>(Data,modeloptim,<span class="dt">pixscale=</span><span class="fl">0.2</span>,<span class="dt">FWHM=</span><span class="fl">0.5</span>,<span class="dt">SBlim=</span><span class="dv">26</span>)</code></pre></div>
<p>Using constraints it is possible to force relative sizes between componenets etc. Here we do not want the bulge Re to become larger than the disk Re. We make the function and then put it in the Data list manually. You cannot properly use constraints using R’s optim function, but you can using LaplaceApproximation and LaplacesDemon because they receive modifications to the input parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">constraints=function(modellist){
  if(modellist$sersic$re[<span class="dv">1</span>]&gt;modellist$sersic$re[<span class="dv">2</span>]){
    modellist$sersic$re[<span class="dv">1</span>]=modellist$sersic$re[<span class="dv">2</span>]
  }
  return=modellist
}
Data$constraints=constraints</code></pre></div>
<p>Now we can try a <code>LaplaceApproximation</code> LM fit. This should take a few minutes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(LaplacesDemon)
Data$algo.func =<span class="st"> &quot;LA&quot;</span>
LAfit=<span class="kw">LaplaceApproximation</span>(profitLikeModel, <span class="dt">parm=</span>Data$init, <span class="dt">Data=</span>Data, <span class="dt">Iterations=</span><span class="fl">1e3</span>,
                           <span class="dt">Method=</span><span class="st">'LM'</span>, <span class="dt">CovEst=</span><span class="st">'Identity'</span>, <span class="dt">sir=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>The best LA LM fit is given by:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LAfit$Summary1[,<span class="dv">1</span>]</code></pre></div>
<p>Check it out:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(LAfit$Summary1[,<span class="dv">1</span>],Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">1</span>))
<span class="kw">profitLikeModel</span>(LAfit$Summary1[,<span class="dv">1</span>],Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">2</span>))
<span class="kw">profitLikeModel</span>(LAfit$Summary1[,<span class="dv">1</span>],Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="st">'all'</span>))

modeloptim=<span class="kw">profitRemakeModellist</span>(LAfit$Summary1[,<span class="dv">1</span>],Data$modellist,Data$tofit,Data$tolog)
<span class="kw">profitEllipsePlot</span>(Data,modeloptim,<span class="dt">pixscale=</span><span class="fl">0.2</span>,<span class="dt">FWHM=</span><span class="fl">0.5</span>,<span class="dt">SBlim=</span><span class="dv">26</span>)</code></pre></div>
<p>Other optimizers can be used. One particularly effective algorithm is <code>CMA-ES</code> (<code>Covariance Matrix Adaptation - Evolutionary Strategy</code>). <code>CMA-ES</code> samples multiple points (members of a population) from the supplied priors, and then adapts the priors each iteration, shrinking the parameter space that points are sampled from to converge on the best fit. It is a popular optimizer as it is fairly robust (but not immune) to becoming trapped in local minima while still fairly quick to converge.</p>
<p>First make sure that the <code>cmaeshpc</code> package is installed:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">'taranu/cmaeshpc'</span>)</code></pre></div>
<p>It is recommended to use narrower priors than the very broad ones specified above to speed up convergence:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cmaeshpc)
Data$algo.func =<span class="st"> &quot;CMA&quot;</span>
sigmas=<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">30</span>,<span class="dv">30</span>,<span class="fl">0.3</span>,<span class="fl">0.3</span>)
cmasigma =<span class="st"> </span>sigmas[<span class="kw">which</span>(<span class="kw">unlist</span>(tofit) ==<span class="st"> </span><span class="ot">TRUE</span>)]/<span class="dv">3</span>
cmafit =<span class="st"> </span><span class="kw">cmaeshpc</span>(Data$init, profitLikeModel, <span class="dt">Data=</span>Data, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">maxit=</span><span class="fl">1e3</span>,
  <span class="dt">fnscale=</span>-<span class="fl">1.0</span>, <span class="dt">sigma=</span>cmasigma, <span class="dt">diag.sigma=</span><span class="ot">TRUE</span>, <span class="dt">diag.eigen=</span><span class="ot">TRUE</span>, <span class="dt">diag.pop=</span><span class="ot">TRUE</span>,
  <span class="dt">diag.value=</span><span class="ot">TRUE</span>, <span class="dt">maxwalltime=</span><span class="ot">Inf</span>, <span class="dt">trace=</span><span class="ot">TRUE</span>, <span class="dt">stopfitness =</span> <span class="dv">0</span>, <span class="dt">stop.tolx=</span><span class="fl">1e-3</span>*cmasigma))
<span class="kw">profitLikeModel</span>(cmafit$par,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><code>CMA-ES</code> sometimes takes longer than <code>LaplaceApproximation</code> - depending on the convergence criterion specified by <code>stop.tolx</code> - but it usually finds a better fit, and can be run many times to avoid becoming trapped in local minima. Alternately, you may wish to use the faster <code>LaplaceApproximation</code> first, redefine your priors, and then run <code>CMA-ES</code> to search around the <code>LaplaceApproximation</code> best fit.</p>
<p>Now we can try a <code>LaplacesDemon</code> fit (this will take about an hour):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Data$algo.func =<span class="st"> &quot;LD&quot;</span>

LDfit=<span class="kw">LaplacesDemon</span>(profitLikeModel, <span class="dt">Initial.Values=</span>LAfit$Summary1[,<span class="dv">1</span>], <span class="dt">Data=</span>Data,
  <span class="dt">Iterations=</span><span class="fl">1e4</span>, <span class="dt">Algorithm=</span><span class="st">'CHARM'</span>, <span class="dt">Thinning=</span><span class="dv">1</span>, <span class="dt">Specs=</span><span class="kw">list</span>(<span class="dt">alpha.star=</span><span class="fl">0.44</span>))</code></pre></div>
<p>If it has converged well you will have a Summary2 structure using the ESS:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LDfit$Summary2</code></pre></div>
<p>If not you can still check Summary1:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LDfit$Summary1</code></pre></div>
<p>The global fit should be close to the initial LA fit (shown in blue in the following figures).</p>
<p>With any luck you have enough stationary samples to run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">BestLD=<span class="kw">magtri</span>(LDfit$Posterior2, <span class="dt">samples=</span><span class="dv">500</span>, <span class="dt">samptype=</span><span class="st">'ran'</span>)</code></pre></div>
<p>Otherwise try:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">BestLD=<span class="kw">magtri</span>(LDfit$Posterior1, <span class="dt">samples=</span><span class="dv">1000</span>, <span class="dt">samptype=</span><span class="st">'end'</span>)</code></pre></div>
<p>We can now check our final fit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(BestLD,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">1</span>))
<span class="kw">profitLikeModel</span>(BestLD,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="dv">2</span>))
<span class="kw">profitLikeModel</span>(BestLD,Data,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="st">'all'</span>))

modeloptim=<span class="kw">profitRemakeModellist</span>(BestLD,Data$modellist,Data$tofit,Data$tolog)
<span class="kw">profitEllipsePlot</span>(Data,modeloptim,<span class="dt">pixscale=</span><span class="fl">0.2</span>,<span class="dt">FWHM=</span><span class="fl">0.5</span>,<span class="dt">SBlim=</span><span class="dv">26</span>)</code></pre></div>
<p>In the previous examples, the resolution of the convolved model was limited by the size of the pixels, since convolution can only spread flux from pixel-to-pixel. We can do better by sampling the model and PSF on a finer grid than the pixel scale (“fine-sampling”), through interpolation for empirical PSFs.</p>
<p>To test this, set up the data again. This time we will fine-sample the model and PSF by a factor of 3, taking a minute to benchmark convolution methods:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Dataf=<span class="kw">profitSetupData</span>(<span class="dt">image=</span>image, <span class="dt">sigma=</span>sigma, <span class="dt">segim=</span>segim, <span class="dt">mask=</span>mask, <span class="dt">psf=</span>psf,
  <span class="dt">modellist=</span>modellist, <span class="dt">tofit=</span>tofit, <span class="dt">tolog=</span>tolog, <span class="dt">priors=</span>priors, <span class="dt">intervals=</span>intervals,
  <span class="dt">magzero=</span><span class="dv">0</span>, <span class="dt">algo.func=</span><span class="st">'LD'</span>, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">nbenchmark=</span>3L, <span class="dt">finesample=</span>3L)</code></pre></div>
<p>Note that profitSetupData automagically fine-sampled the PSF by interpolation. Usually, brute-force convolution is faster than an FFT (which requires 2x padding to avoid artifacts), but it scales as finesample^4, so FFT is often faster with large images and/or PSFs.</p>
<p>Let’s check to see how the fine-sampled model looks:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(BestLD,Dataf,<span class="dt">makeplots=</span><span class="ot">TRUE</span>,<span class="dt">whichcomponents=</span><span class="kw">list</span>(<span class="dt">sersic=</span><span class="st">'all'</span>))</code></pre></div>
<p>That doesn’t look so different, but let’s run <code>LaplaceApproximation</code> again to see how the best-fit parameters changed:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Dataf$algo.func =<span class="st"> &quot;LA&quot;</span>
LAfitf=<span class="kw">LaplaceApproximation</span>(profitLikeModel, <span class="dt">parm=</span>LAfit$Summary1[,<span class="dv">1</span>], <span class="dt">Data=</span>Dataf, <span class="dt">Iterations=</span><span class="fl">1e3</span>,
  <span class="dt">Method=</span><span class="st">'BFGS'</span>, <span class="dt">CovEst=</span><span class="st">'Identity'</span>, <span class="dt">sir=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>Does the new best fit look slightly better? It should:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profitLikeModel</span>(LAfitf$Summary1[,<span class="dv">1</span>],Dataf,<span class="dt">makeplots=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>Now run <code>LaplacesDemon</code> again, with fewer iterations to begin with (as it’s slower to convolve):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Dataf$algo.func =<span class="st"> &quot;LD&quot;</span>

LDfitf=<span class="kw">LaplacesDemon</span>(profitLikeModel, <span class="dt">Initial.Values=</span>LAfitf$Summary1[,<span class="dv">1</span>], <span class="dt">Data=</span>Dataf,
  <span class="dt">Iterations=</span><span class="fl">1e3</span>, <span class="dt">Algorithm=</span><span class="st">'CHARM'</span>, <span class="dt">Thinning=</span><span class="dv">1</span>, <span class="dt">Specs=</span><span class="kw">list</span>(<span class="dt">alpha.star=</span><span class="fl">0.44</span>))</code></pre></div>
<p>If you run the above for 1e4 iterations (will take several hours), try comparing posteriors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">LDfit$Summary2
LDfitf$Summary2

BestLDf=<span class="kw">magtri</span>(LDfit$Posterior1, <span class="dt">samptype=</span><span class="st">'end'</span>)
<span class="kw">profitLikeModel</span>(BestLDf,Dataf,<span class="dt">makeplots=</span><span class="ot">TRUE</span>)</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
